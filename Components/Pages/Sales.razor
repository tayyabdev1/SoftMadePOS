@page "/sales"
@using Microsoft.EntityFrameworkCore
@using Shop.Models
@inject IDbContextFactory<AppDbContext> DbFactory
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3>Sales History</h3>
            <span class="text-muted small">
                Showing: <strong>@CurrentViewLabel</strong>
            </span>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-white p-3 d-flex justify-content-between align-items-center">
            <input type="text" class="form-control w-50" placeholder="Search loaded sales..."
                   @bind="SearchTerm" @bind:event="oninput" />

            <span class="badge bg-secondary">Total Loaded: @SaleList.Count</span>
        </div>

        <div class="card-body p-0 table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="bg-light">
                    <tr>
                        <th>Invoice #</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Payment</th>
                        <th>Net Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @if (IsLoading)
                    {
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Fetching data...</p>
                            </td>
                        </tr>
                    }
                    else if (FilteredSales.Count == 0)
                    {
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">
                                No sales found for this period.
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var s in FilteredSales)
                        {
                            <tr>
                                <td><span class="badge bg-secondary">#@s.Id</span></td>
                                <td>@s.Date.ToString("dd MMM yyyy, hh:mm tt")</td>
                                <td class="fw-bold">
                                    @(s.Customer != null ? s.Customer.Name : "Walk-in Customer")
                                </td>
                                <td><span class="badge bg-info text-dark">@s.PaymentMethod</span></td>
                                <td class="fw-bold text-success">Rs. @s.NetTotal.ToString("N0")</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => OpenDetailsModal(s.Id)">
                                        <i class="bi bi-eye-fill me-1"></i> View
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        @if (CurrentHistoryMode != HistoryMode.All)
        {
            <div class="card-footer bg-light text-center p-3">
                <button class="btn btn-primary px-4 fw-bold" @onclick="LoadMoreData" disabled="@IsLoading">
                    @if (IsLoading)
                    {
                        <span>Loading...</span>
                    }
                    else
                    {
                        <i class="bi bi-clock-history me-2"></i> @NextButtonLabel
                    }
                </button>
            </div>
        }
    </div>
</div>

@if (ShowDetailsModal)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Invoice #@SelectedSaleId Details</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body p-0">
                    @if (CurrentSaleDetails == null)
                    {
                        <div class="p-4 text-center">Loading...</div>
                    }
                    else
                    {
                        <table class="table table-striped mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th>Product</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-end">Unit Price</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in CurrentSaleDetails)
                                {
                                    <tr>
                                        <td class="fw-bold">@item.Product.Name</td>
                                        <td class="text-center">@item.Quantity</td>
                                        <td class="text-end">@item.SalePrice.ToString("N0")</td>
                                        <td class="text-end fw-bold">
                                            @((item.Quantity * item.SalePrice).ToString("N0"))
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="table-group-divider">
                                <tr>
                                    <td colspan="3" class="text-end fw-bold">Grand Total:</td>
                                    <td class="text-end fw-bold text-success">
                                        Rs. @CurrentSaleDetails.Sum(x => x.Quantity * x.SalePrice).ToString("N0")
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // ENUMS FOR LOGIC
    private enum HistoryMode { Last3Days, Last7Days, Last30Days, All }

    // STATE
    private List<Sale> SaleList = new();
    private List<SaleDetails> CurrentSaleDetails = new();
    private string SearchTerm = "";
    private bool ShowDetailsModal = false;
    private int SelectedSaleId = 0;
    private bool IsLoading = false;

    // PROGRESSIVE LOADING STATE
    private HistoryMode CurrentHistoryMode = HistoryMode.Last3Days;

    protected override async Task OnInitializedAsync()
    {
        await LoadSales();
    }

    private async Task LoadSales()
    {
        IsLoading = true;
        // Small delay to let UI show spinner
        await Task.Delay(1);

        using var context = DbFactory.CreateDbContext();

        var query = context.Sales
            .Include(s => s.Customer)
            .OrderByDescending(s => s.Id)
            .AsNoTracking(); // Optimization

        // Apply Date Filters based on Mode
        DateTime limitDate = DateTime.Now;

        switch (CurrentHistoryMode)
        {
            case HistoryMode.Last3Days:
                limitDate = DateTime.Now.AddDays(-3);
                query = query.Where(s => s.Date >= limitDate);
                break;
            case HistoryMode.Last7Days:
                limitDate = DateTime.Now.AddDays(-7);
                query = query.Where(s => s.Date >= limitDate);
                break;
            case HistoryMode.Last30Days:
                limitDate = DateTime.Now.AddDays(-30);
                query = query.Where(s => s.Date >= limitDate);
                break;
            case HistoryMode.All:
                // No filter (Load Everything)
                break;
        }

        SaleList = await query.ToListAsync();
        IsLoading = false;
    }

    private async Task LoadMoreData()
    {
        // Cycle to the next mode
        if (CurrentHistoryMode == HistoryMode.Last3Days) CurrentHistoryMode = HistoryMode.Last7Days;
        else if (CurrentHistoryMode == HistoryMode.Last7Days) CurrentHistoryMode = HistoryMode.Last30Days;
        else if (CurrentHistoryMode == HistoryMode.Last30Days) CurrentHistoryMode = HistoryMode.All;

        await LoadSales();
    }

    // UI LABELS
    private string CurrentViewLabel => CurrentHistoryMode switch
    {
        HistoryMode.Last3Days => "Last 3 Days",
        HistoryMode.Last7Days => "Last 7 Days",
        HistoryMode.Last30Days => "Last 30 Days",
        HistoryMode.All => "All History (Full)",
        _ => ""
    };

    private string NextButtonLabel => CurrentHistoryMode switch
    {
        HistoryMode.Last3Days => "Load Last 7 Days",
        HistoryMode.Last7Days => "Load Last 30 Days",
        HistoryMode.Last30Days => "Load All Data",
        _ => ""
    };

    // MODAL LOGIC
    private async Task OpenDetailsModal(int saleId)
    {
        SelectedSaleId = saleId;
        ShowDetailsModal = true;
        CurrentSaleDetails = null;

        using var context = DbFactory.CreateDbContext();
        CurrentSaleDetails = await context.SaleDetails
            .Include(sd => sd.Product)
            .Where(sd => sd.SaleId == saleId)
            .AsNoTracking()
            .ToListAsync();
    }

    private void CloseModal() => ShowDetailsModal = false;

    private List<Sale> FilteredSales => SaleList
        .Where(s => string.IsNullOrEmpty(SearchTerm) ||
                    s.Id.ToString().Contains(SearchTerm) ||
                    (s.Customer != null && s.Customer.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)))
        .ToList();
}